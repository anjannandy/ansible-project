---
# ===== USER CREATION (Parallel within step) =====
- name: Create kubeadmin user on all nodes
  hosts: kubernetes
  become: no
  gather_facts: yes
  strategy: free  # Parallel execution within this step
  tasks:
    - name: Check if kubeadmin user exists
      getent:
        database: passwd
        key: kubeadmin
      register: kubeadmin_exists
      failed_when: false

    - name: Create kubeadmin user
      script: ../scripts/user-management/create_kubeadmin.sh
      register: user_creation_result
      when: kubeadmin_exists.failed

    - name: Display user creation result
      debug:
        msg: "kubeadmin user: {{ 'Already exists' if not kubeadmin_exists.failed else 'Created' }}"

# ===== STEP 1: SYSTEM PREPARATION (Parallel within step) =====
- name: STEP 1 - System Preparation
  hosts: kubernetes
  become: no
  gather_facts: yes
  strategy: free  # All nodes process in parallel
  vars:
    ansible_user: kubeadmin
    kubeadmin_script_dir: "/home/kubeadmin/k8s-scripts"
    kubeadmin_log_dir: "/home/kubeadmin/k8s-setup-logs"
    kubeadmin_state_dir: "/home/kubeadmin/k8s-setup-state"
    max_retries: 3

  tasks:
    - name: Display step 1 start
      debug:
        msg: "üîß STEP 1: Starting system preparation on {{ inventory_hostname }}"

    - name: Create directories for kubeadmin user
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: kubeadmin
        group: kubeadmin
      loop:
        - "{{ kubeadmin_script_dir }}"
        - "{{ kubeadmin_log_dir }}"
        - "{{ kubeadmin_state_dir }}"
      become: yes

    - name: Copy setup scripts to kubeadmin directory
      copy:
        src: "../scripts/k8s/{{ item }}"
        dest: "{{ kubeadmin_script_dir }}/{{ item }}"
        mode: '0755'
        owner: kubeadmin
        group: kubeadmin
      loop:
        - setup_k8s.sh
        - utils.sh
        - run_step.sh
        - cluster_status.sh

    - name: Check if system preparation already completed
      stat:
        path: "{{ kubeadmin_state_dir }}/01_system_prep_completed"
      register: step1_status

    - name: Execute system preparation
      command: "{{ kubeadm_script_dir }}/run_step.sh system_prep"
      register: step1_result
      retries: "{{ max_retries }}"
      delay: 30
      until: step1_result.rc == 0
      when: not step1_status.stat.exists
      timeout: 1200
      environment:
        HOME: "/home/kubeadmin"
        LOG_FILE: "{{ kubeadmin_log_dir }}/{{ inventory_hostname }}-setup.log"
        STATE_DIR: "{{ kubeadmin_state_dir }}"
        NODE_ROLE: "{{ node_role }}"

    - name: Display system prep results
      debug:
        msg: "‚úÖ STEP 1 - System prep on {{ inventory_hostname }}: {{ 'SKIPPED (already completed)' if step1_status.stat.exists else ('SUCCESS' if step1_result is defined and step1_result.rc == 0 else 'FAILED') }}"

# ===== STEP 2: DOCKER INSTALLATION (Parallel within step) =====
- name: STEP 2 - Docker Installation
  hosts: kubernetes
  become: no
  gather_facts: no
  strategy: free  # All nodes process in parallel
  vars:
    ansible_user: kubeadmin
    kubeadmin_script_dir: "/home/kubeadmin/k8s-scripts"
    kubeadmin_log_dir: "/home/kubeadmin/k8s-setup-logs"
    kubeadmin_state_dir: "/home/kubeadmin/k8s-setup-state"
    max_retries: 3

  tasks:
    - name: Display step 2 start
      debug:
        msg: "üê≥ STEP 2: Starting Docker installation on {{ inventory_hostname }}"

    - name: Check if Docker installation already completed
      stat:
        path: "{{ kubeadmin_state_dir }}/02_docker_install_completed"
      register: step2_status

    - name: Check Docker service status as fallback
      systemd:
        name: docker
      register: docker_service_status
      failed_when: false
      when: not step2_status.stat.exists

    - name: Install Docker
      command: "{{ kubeadmin_script_dir }}/run_step.sh install_docker"
      register: step2_result
      retries: "{{ max_retries }}"
      delay: 30
      until: step2_result.rc == 0
      when:
        - not step2_status.stat.exists
        - docker_service_status is not defined or docker_service_status.status.ActiveState != 'active'
      timeout: 1200
      environment:
        HOME: "/home/kubeadmin"
        LOG_FILE: "{{ kubeadmin_log_dir }}/{{ inventory_hostname }}-setup.log"
        STATE_DIR: "{{ kubeadmin_state_dir }}"
        NODE_ROLE: "{{ node_role }}"

    - name: Display Docker install results
      debug:
        msg: "‚úÖ STEP 2 - Docker install on {{ inventory_hostname }}: {{ 'SKIPPED (already completed)' if step2_status.stat.exists or (docker_service_status is defined and docker_service_status.status.ActiveState == 'active') else ('SUCCESS' if step2_result is defined and step2_result.rc == 0 else 'FAILED') }}"

# ===== STEP 3: KUBERNETES INSTALLATION (Parallel within step) =====
- name: STEP 3 - Kubernetes Installation
  hosts: kubernetes
  become: no
  gather_facts: no
  strategy: free  # All nodes process in parallel
  vars:
    ansible_user: kubeadmin
    kubeadmin_script_dir: "/home/kubeadmin/k8s-scripts"
    kubeadmin_log_dir: "/home/kubeadmin/k8s-setup-logs"
    kubeadmin_state_dir: "/home/kubeadmin/k8s-setup-state"
    max_retries: 3

  tasks:
    - name: Display step 3 start
      debug:
        msg: "‚ò∏Ô∏è  STEP 3: Starting Kubernetes installation on {{ inventory_hostname }}"

    - name: Check if Kubernetes installation already completed
      stat:
        path: "{{ kubeadmin_state_dir }}/03_k8s_install_completed"
      register: step3_status

    - name: Check if kubectl is already installed
      command: kubectl version --client --short
      register: kubectl_check
      failed_when: false
      when: not step3_status.stat.exists

    - name: Install Kubernetes components
      command: "{{ kubeadmin_script_dir }}/run_step.sh install_kubernetes"
      register: step3_result
      retries: "{{ max_retries }}"
      delay: 30
      until: step3_result.rc == 0
      when:
        - not step3_status.stat.exists
        - kubectl_check is not defined or kubectl_check.rc != 0
      timeout: 1200
      environment:
        HOME: "/home/kubeadmin"
        LOG_FILE: "{{ kubeadmin_log_dir }}/{{ inventory_hostname }}-setup.log"
        STATE_DIR: "{{ kubeadmin_state_dir }}"
        NODE_ROLE: "{{ node_role }}"

    - name: Display Kubernetes install results
      debug:
        msg: "‚úÖ STEP 3 - Kubernetes install on {{ inventory_hostname }}: {{ 'SKIPPED (already completed)' if step3_status.stat.exists or (kubectl_check is defined and kubectl_check.rc == 0) else ('SUCCESS' if step3_result is defined and step3_result.rc == 0 else 'FAILED') }}"

# ===== STEP 4: SYSTEM CONFIGURATION (Parallel within step) =====
- name: STEP 4 - System Configuration
  hosts: kubernetes
  become: no
  gather_facts: no
  strategy: free  # All nodes process in parallel
  vars:
    ansible_user: kubeadmin
    kubeadmin_script_dir: "/home/kubeadmin/k8s-scripts"
    kubeadmin_log_dir: "/home/kubeadmin/k8s-setup-logs"
    kubeadmin_state_dir: "/home/kubeadmin/k8s-setup-state"
    max_retries: 3

  tasks:
    - name: Display step 4 start
      debug:
        msg: "‚öôÔ∏è  STEP 4: Starting system configuration on {{ inventory_hostname }}"

    - name: Check if system configuration already completed
      stat:
        path: "{{ kubeadmin_state_dir }}/04_system_config_completed"
      register: step4_status

    - name: Configure system for Kubernetes
      command: "{{ kubeadmin_script_dir }}/run_step.sh configure_system"
      register: step4_result
      retries: "{{ max_retries }}"
      delay: 30
      until: step4_result.rc == 0
      when: not step4_status.stat.exists
      timeout: 600
      environment:
        HOME: "/home/kubeadmin"
        LOG_FILE: "{{ kubeadmin_log_dir }}/{{ inventory_hostname }}-setup.log"
        STATE_DIR: "{{ kubeadmin_state_dir }}"
        NODE_ROLE: "{{ node_role }}"

    - name: Display system config results
      debug:
        msg: "‚úÖ STEP 4 - System config on {{ inventory_hostname }}: {{ 'SKIPPED (already completed)' if step4_status.stat.exists else ('SUCCESS' if step4_result is defined and step4_result.rc == 0 else 'FAILED') }}"

# ===== STEP 5: MASTER INITIALIZATION (Serial - only master node) =====
- name: STEP 5 - Master Initialization
  hosts: master
  become: no
  gather_facts: no
  strategy: linear  # Only one master node, but explicit
  vars:
    ansible_user: kubeadmin
    kubeadmin_script_dir: "/home/kubeadmin/k8s-scripts"
    kubeadmin_log_dir: "/home/kubeadmin/k8s-setup-logs"
    kubeadmin_state_dir: "/home/kubeadmin/k8s-setup-state"
    pod_network_cidr: "10.244.0.0/16"

  tasks:
    - name: Display step 5 start
      debug:
        msg: "üéØ STEP 5: Starting master initialization on {{ inventory_hostname }}"

    - name: Check if master initialization already completed
      stat:
        path: "{{ kubeadmin_state_dir }}/05_master_init_completed"
      register: master_status

    - name: Check if cluster is already initialized
      command: kubectl cluster-info
      register: cluster_check
      failed_when: false
      environment:
        HOME: "/home/kubeadmin"
        KUBECONFIG: "/home/kubeadmin/.kube/config"
      when: not master_status.stat.exists

    - name: Initialize master
      command: "{{ kubeadmin_script_dir }}/run_step.sh initialize_master"
      register: master_result
      when:
        - not master_status.stat.exists
        - cluster_check is not defined or cluster_check.rc != 0
      timeout: 900
      environment:
        HOME: "/home/kubeadmin"
        LOG_FILE: "{{ kubeadmin_log_dir }}/{{ inventory_hostname }}-setup.log"
        STATE_DIR: "{{ kubeadmin_state_dir }}"
        POD_CIDR: "{{ pod_network_cidr }}"
        NODE_ROLE: "master"
        K8S_ADMIN_USER: "kubeadmin"

    - name: Display master init results
      debug:
        msg: "‚úÖ STEP 5 - Master init: {{ 'SKIPPED (already completed)' if master_status.stat.exists or (cluster_check is defined and cluster_check.rc == 0) else ('SUCCESS' if master_result is defined and master_result.rc == 0 else 'FAILED') }}"

# ===== STEP 6: CNI INSTALLATION (Serial - only master node) =====
- name: STEP 6 - CNI Installation
  hosts: master
  become: no
  gather_facts: no
  strategy: linear  # Only master node
  vars:
    ansible_user: kubeadmin
    kubeadmin_script_dir: "/home/kubeadmin/k8s-scripts"
    kubeadmin_log_dir: "/home/kubeadmin/k8s-setup-logs"
    kubeadmin_state_dir: "/home/kubeadmin/k8s-setup-state"

  tasks:
    - name: Display step 6 start
      debug:
        msg: "üåê STEP 6: Starting CNI installation on {{ inventory_hostname }}"

    - name: Check if CNI already installed
      stat:
        path: "{{ kubeadmin_state_dir }}/06_cni_install_completed"
      register: cni_status

    - name: Check if flannel pods are running
      command: kubectl get pods -n kube-flannel -o json
      register: flannel_check
      failed_when: false
      environment:
        HOME: "/home/kubeadmin"
        KUBECONFIG: "/home/kubeadmin/.kube/config"
      when: not cni_status.stat.exists

    - name: Install CNI (Flannel)
      command: "{{ kubeadmin_script_dir }}/run_step.sh install_cni"
      register: cni_result
      when:
        - not cni_status.stat.exists
        - flannel_check is not defined or flannel_check.rc != 0
      timeout: 600
      environment:
        HOME: "/home/kubeadmin"
        LOG_FILE: "{{ kubeadmin_log_dir }}/{{ inventory_hostname }}-setup.log"
        STATE_DIR: "{{ kubeadmin_state_dir }}"
        K8S_ADMIN_USER: "kubeadmin"

    - name: Display CNI install results
      debug:
        msg: "‚úÖ STEP 6 - CNI install: {{ 'SKIPPED (already completed)' if cni_status.stat.exists or (flannel_check is defined and flannel_check.rc == 0) else ('SUCCESS' if cni_result is defined and cni_result.rc == 0 else 'FAILED') }}"

# ===== STEP 7: WORKER JOIN (Parallel within step) =====
- name: STEP 7 - Worker Join
  hosts: workers
  become: no
  gather_facts: no
  strategy: free  # All worker nodes join in parallel
  vars:
    ansible_user: kubeadmin
    kubeadmin_state_dir: "/home/kubeadmin/k8s-setup-state"

  tasks:
    - name: Display step 7 start
      debug:
        msg: "üîó STEP 7: Starting worker join on {{ inventory_hostname }}"

    - name: Check if worker already joined cluster
      stat:
        path: "{{ kubeadmin_state_dir }}/07_worker_join_completed"
      register: worker_status

    - name: Check if node is already part of cluster
      command: kubectl get nodes {{ inventory_hostname }} -o name
      register: node_check
      failed_when: false
      delegate_to: "{{ groups['master'][0] }}"
      environment:
        HOME: "/home/kubeadmin"
        KUBECONFIG: "/home/kubeadmin/.kube/config"
      when: not worker_status.stat.exists

    - name: Get join command from master
      slurp:
        src: "/home/kubeadmin/kubeadm-join-command.sh"
      register: join_command_content
      delegate_to: "{{ groups['master'][0] }}"
      when:
        - not worker_status.stat.exists
        - node_check is not defined or node_check.rc != 0

    - name: Write join command to worker
      copy:
        content: "{{ join_command_content.content | b64decode }}"
        dest: "/tmp/kubeadm-join-command.sh"
        mode: '0755'
      when:
        - not worker_status.stat.exists
        - node_check is not defined or node_check.rc != 0
        - join_command_content is defined

    - name: Execute join command
      command: "sudo bash /tmp/kubeadm-join-command.sh"
      register: worker_result
      timeout: 600
      when:
        - not worker_status.stat.exists
        - node_check is not defined or node_check.rc != 0
        - join_command_content is defined

    - name: Mark worker join as completed
      file:
        path: "{{ kubeadmin_state_dir }}/07_worker_join_completed"
        state: touch
        mode: '0644'
      when: worker_result is defined and worker_result.rc == 0

    - name: Clean up join command file
      file:
        path: "/tmp/kubeadm-join-command.sh"
        state: absent
      when: join_command_content is defined

    - name: Display worker join results
      debug:
        msg: "‚úÖ STEP 7 - Worker join on {{ inventory_hostname }}: {{ 'SKIPPED (already joined)' if worker_status.stat.exists or (node_check is defined and node_check.rc == 0) else ('SUCCESS' if worker_result is defined and worker_result.rc == 0 else 'FAILED') }}"

# ===== STEP 8: FINAL STATUS (Serial - only master node) =====
- name: STEP 8 - Final Cluster Status
  hosts: master
  become: no
  gather_facts: no
  strategy: linear  # Only master node
  vars:
    ansible_user: kubeadmin
    kubeadmin_script_dir: "/home/kubeadmin/k8s-scripts"

  tasks:
    - name: Display step 8 start
      debug:
        msg: "üìä STEP 8: Getting final cluster status"

    - name: Wait for all nodes to be ready
      command: kubectl get nodes --no-headers
      register: nodes_status
      retries: 12
      delay: 10
      until:
        - nodes_status.stdout_lines | length == groups['kubernetes'] | length
        - "'NotReady' not in nodes_status.stdout"
      environment:
        HOME: "/home/kubeadmin"
        KUBECONFIG: "/home/kubeadmin/.kube/config"

    - name: Get final cluster status
      command: "{{ kubeadmin_script_dir }}/cluster_status.sh"
      register: final_status
      environment:
        HOME: "/home/kubeadmin"
        KUBECONFIG: "/home/kubeadmin/.kube/config"

    - name: Display final status
      debug:
        msg: |
          üéâ KUBERNETES CLUSTER STATUS üéâ
          {{ final_status.stdout }}

    - name: Display comprehensive summary
      debug:
        msg: |
          ================================================================
          üìä KUBERNETES CLUSTER SETUP COMPLETE! üìä
          ================================================================
          
          üéØ CLUSTER OVERVIEW
          Total Nodes: {{ groups['kubernetes'] | length }}
          Master Nodes: {{ groups['master'] | length }}  
          Worker Nodes: {{ groups['workers'] | length }}
          
          üìã EXECUTION STRATEGY
          ‚úÖ Steps 1-4: Parallel execution within each step
          ‚úÖ Steps 5-6: Serial execution (master only)
          ‚úÖ Step 7: Parallel worker joins
          ‚úÖ Step 8: Final status check
          
          üöÄ PERFORMANCE BENEFITS
          ‚Ä¢ Parallel system prep across all nodes
          ‚Ä¢ Parallel Docker installation
          ‚Ä¢ Parallel Kubernetes installation  
          ‚Ä¢ Parallel system configuration
          ‚Ä¢ Parallel worker joins
          
          üéØ All nodes ready for workloads!
          ================================================================